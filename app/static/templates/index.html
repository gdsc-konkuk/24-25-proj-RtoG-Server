<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>화재 감지 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .video-container {
            background-color: #000;
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 8px;
            overflow: hidden;
            border: 3px solid transparent;
            transition: border-color 0.3s ease;
        }
        .video-container.fire-detected {
            border-color: #ff4444;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }
        .video-canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            font-size: 0.9em;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2em;
        }
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .fire-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            z-index: 1000;
        }
        .fire-status.high-risk {
            background-color: #ff4444;
        }
        .fire-status.medium-risk {
            background-color: #ffbb33;
        }
        .fire-status.low-risk {
            background-color: #00C851;
        }
        .record-thumb .card-img-top {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .record-thumb.card {
            min-height: 270px;
            max-height: 320px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="mb-4 mt-4">화재 감지 시스템</h1>
        <!-- 탭 네비게이션 -->
        <ul class="nav nav-tabs mb-3" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="live-tab" data-bs-toggle="tab" data-bs-target="#live" type="button" role="tab">Live</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="record-tab" data-bs-toggle="tab" data-bs-target="#record" type="button" role="tab">Record</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="event-tab" data-bs-toggle="tab" data-bs-target="#event" type="button" role="tab">Event</button>
            </li>
        </ul>
        <div class="tab-content" id="mainTabContent">
            <!-- Live 탭 -->
            <div class="tab-pane fade show active" id="live" role="tabpanel">
                <div class="video-grid" id="videoGrid"></div>
            </div>
            <!-- Record 탭 -->
            <div class="tab-pane fade" id="record" role="tabpanel">
                <div id="recordList" class="row p-3">(의심 영상 목록 자리)</div>
            </div>
            <!-- Event 탭 -->
            <div class="tab-pane fade" id="event" role="tabpanel">
                <div id="eventPlayer" class="p-3">(이벤트 영상/타임라인 자리)</div>
            </div>
        </div>
        <div class="alert alert-warning" id="fireAlert" style="display: none;">
            <strong>화재 감지!</strong> <span id="fireAlertMessage"></span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const videoStreams = new Map();
        const fireWs = new WebSocket(`ws://${window.location.host}/ws/suspects`);
        const fireStatusMap = new Map();
        
        // 화재 감지 웹소켓 연결
        fireWs.onopen = () => {
            console.log('화재 감지 WebSocket 연결됨');
            fireWs.send(JSON.stringify({ action: 'subscribe' }));
        };

        fireWs.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.event === 'fire_detected') {
                const videoId = data.data.id;
                const confidence = data.data.confidence;
                const analysis = data.data.analysis;
                
                // 비디오 컨테이너에 화재 상태 표시
                const container = document.querySelector(`.video-container[data-video-id="${videoId}"]`);
                if (container) {
                    // 기존 상태 표시 제거
                    const existingStatus = container.querySelector('.fire-status');
                    if (existingStatus) {
                        existingStatus.remove();
                    }
                    
                    // 위험도에 따른 상태 표시 추가
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'fire-status';
                    
                    if (analysis === '위험') {
                        statusDiv.classList.add('high-risk');
                        statusDiv.textContent = '위험';
                    } else if (analysis === '주의') {
                        statusDiv.classList.add('medium-risk');
                        statusDiv.textContent = '주의';
                    } else {
                        statusDiv.classList.add('low-risk');
                        statusDiv.textContent = '안전';
                    }
                    
                    container.appendChild(statusDiv);
                    container.classList.add('fire-detected');
                    
                    // 5초 후 상태 표시 제거
                    setTimeout(() => {
                        statusDiv.remove();
                        container.classList.remove('fire-detected');
                    }, 5000);
                }
            }
        };

        // Live 탭: 실시간 스트림만 canvas에 표시
        async function fetchVideos() {
            try {
                const response = await fetch('/videos');
                const videos = await response.json();
                const videoGrid = document.getElementById('videoGrid');
                videoGrid.innerHTML = '';
                videos.forEach(video => {
                    const container = document.createElement('div');
                    container.className = 'video-container';
                    container.setAttribute('data-video-id', video.id);
                    container.innerHTML = `
                        <canvas class="video-canvas" id="canvas_${video.id}"></canvas>
                        <div class="loading" id="loading_${video.id}">연결 중...</div>
                        <div class="fire-status" id="fire_status_${video.id}">화재 감지</div>
                        <div class="video-info">
                            <div>${video.cctv_name}</div>
                            <div>${video.location}</div>
                        </div>
                    `;
                    videoGrid.appendChild(container);
                    // 비디오 스트림 시작 (Live 탭에서만)
                    startVideoStream(video);
                });
            } catch (error) {
                console.error('비디오 목록을 가져오는데 실패했습니다:', error);
            }
        }

        // Live 탭: 실시간 스트림 (canvas만)
        function startVideoStream(video) {
            const ws = new WebSocket(`ws://${window.location.host}/ws/stream`);
            const canvas = document.getElementById(`canvas_${video.id}`);
            const ctx = canvas.getContext('2d');
            const loading = document.getElementById(`loading_${video.id}`);
            videoStreams.set(video.id, ws);
            ws.onopen = () => {
                ws.send(JSON.stringify({ action: 'subscribe', video_id: video.id }));
            };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'frame') {
                    loading.style.display = 'none';
                    const img = new Image();
                    img.onload = () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = `data:image/jpeg;base64,${data.frame}`;
                }
            };
            ws.onerror = (error) => {
                loading.textContent = '연결 오류';
            };
            ws.onclose = () => {
                loading.textContent = '연결 종료';
                loading.style.display = 'block';
            };
        }

        // 날짜별 그룹핑 함수
        function groupByDate(records) {
            const groups = {};
            records.forEach(r => {
                // YYYYMMDD_HHMMSS → YYYY.MM.DD
                let dateKey = r.datetime ? r.datetime.slice(0,8) : '';
                if (dateKey.length === 8) {
                    dateKey = `${dateKey.slice(0,4)}.${dateKey.slice(4,6)}.${dateKey.slice(6,8)}`;
                } else {
                    dateKey = '날짜없음';
                }
                if (!groups[dateKey]) groups[dateKey] = [];
                groups[dateKey].push(r);
            });
            return groups;
        }

        // Record 탭: 의심 영상 목록 불러오기 및 표시 (날짜별 그룹핑)
        async function fetchRecords() {
            const recordList = document.getElementById('recordList');
            recordList.innerHTML = '<div class="text-secondary">로딩 중...</div>';
            try {
                const res = await fetch('/records');
                const records = await res.json();
                if (records.length === 0) {
                    recordList.innerHTML = '<div class="text-secondary">저장된 의심 영상이 없습니다.</div>';
                    return;
                }
                recordList.innerHTML = '';
                const groups = groupByDate(records.reverse());
                Object.keys(groups).forEach(dateKey => {
                    const dateTitle = document.createElement('h5');
                    dateTitle.className = 'mt-4 mb-2';
                    dateTitle.textContent = dateKey;
                    recordList.appendChild(dateTitle);
                    const row = document.createElement('div');
                    row.className = 'row';
                    groups[dateKey].forEach(record => {
                        const col = document.createElement('div');
                        col.className = 'col-md-3 mb-4';
                        col.innerHTML = `
                            <div class="card h-100 record-thumb" style="cursor:pointer;" data-video-url="${record.video_url}" data-thumb-url="${record.thumb_url}" data-datetime="${record.datetime}">
                                <img src="${record.thumb_url}" class="card-img-top" alt="썸네일">
                                <div class="card-body">
                                    <h6 class="card-title">${record.video_id ? 'CCTV_' + record.video_id : ''}</h6>
                                    <p class="card-text text-secondary">${record.datetime}</p>
                                </div>
                            </div>
                        `;
                        row.appendChild(col);
                    });
                    recordList.appendChild(row);
                });
                // 썸네일 클릭 시 Event 탭으로 이동
                document.querySelectorAll('.record-thumb').forEach(el => {
                    el.addEventListener('click', function() {
                        let videoUrl = this.dataset.videoUrl;
                        let thumbUrl = this.dataset.thumbUrl;
                        let datetime = this.dataset.datetime;
                        // mp4 경로 강제 보정 및 /static/suspects/ 경로로 변환
                        let fileName = videoUrl.split('/').pop();
                        videoUrl = `/static/suspects/${fileName}`;
                        console.log('Event 탭으로 전달되는 videoUrl:', videoUrl);
                        showEventPlayer(videoUrl, thumbUrl, datetime);
                        const eventTab = new bootstrap.Tab(document.getElementById('event-tab'));
                        eventTab.show();
                    });
                });
            } catch (e) {
                recordList.innerHTML = '<div class="text-danger">의심 영상 목록을 불러오지 못했습니다.</div>';
            }
        }

        // Event 탭: 영상 재생 및 정보 표시 (mp4만, 실시간 프레임 X)
        function showEventPlayer(videoUrl, thumbUrl, datetime) {
            const eventPlayer = document.getElementById('eventPlayer');
            eventPlayer.innerHTML = `
                <div class="card mx-auto" style="max-width:600px;">
                    <video id="eventVideo" src="${videoUrl}" controls autoplay muted playsinline preload="auto" style="width:100%;border-radius:8px;"></video>
                    <div class="card-body">
                        <div class="mb-2 text-secondary">${datetime}</div>
                        <div id="eventTimeline">(타임라인 자리)</div>
                    </div>
                </div>
            `;
            setTimeout(() => {
                const v = document.getElementById('eventVideo');
                if (v) {
                    v.currentTime = 0;
                    v.play().catch(() => {});
                }
            }, 200);
        }

        // Live 탭 WebSocket 모두 닫기
        function closeAllLiveStreams() {
            videoStreams.forEach((ws) => {
                try { ws.close(); } catch (e) {}
            });
            videoStreams.clear();
        }

        // 탭 전환 시 WebSocket 관리
        document.addEventListener('DOMContentLoaded', () => {
            fetchVideos();
            document.getElementById('record-tab').addEventListener('shown.bs.tab', () => {
                closeAllLiveStreams();
                fetchRecords();
            });
            document.getElementById('event-tab').addEventListener('shown.bs.tab', () => {
                closeAllLiveStreams();
            });
            document.getElementById('live-tab').addEventListener('shown.bs.tab', () => {
                fetchVideos();
            });
        });
    </script>
</body>
</html> 